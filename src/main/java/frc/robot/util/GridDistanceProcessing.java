package frc.robot.util;

import edu.wpi.first.math.geometry.Pose2d;
import edu.wpi.first.math.geometry.Rotation2d;

public class GridDistanceProcessing {

    private byte[] map;        // original heatmap
    private int mapLength;
    private int mapWidth;

    private double fieldLength = 16.6;
    private double fieldWidth  = 8.1;

    private double lengthModifier;
    private double widthModifier;

    private static final int LOOKAHEAD_STEPS = 3;

    private static final int OBSTACLE_RADIUS_CELLS = 2; // <<< TUNE THIS

    public GridDistanceProcessing() {
    map = new byte[]{
  26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 
  25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 
  24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 
  23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 
  22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 11, 12, 13, 14, -1, -1, -1, -1, -1, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, -1, -1, -1, -1, -1, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 
  21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 10, 11, 12, 13, -1, -1, -1, -1, -1, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, -1, -1, -1, -1, -1, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 
  20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 9, 10, 11, 12, -1, -1, -1, -1, -1, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, -1, -1, -1, -1, -1, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, -1, -1, -1, -1, 
  19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 8, 9, 10, 11, -1, -1, -1, -1, -1, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, -1, -1, -1, -1, -1, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, -1, -1, -1, -1, 
  18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 7, 8, 9, 10, -1, -1, -1, -1, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, -1, -1, -1, -1, -1, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, -1, -1, -1, -1, 
  17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 6, 7, 8, 9, -1, -1, -1, -1, -1, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, -1, -1, -1, -1, -1, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, -1, -1, -1, -1, 
  16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 5, 6, 7, 8, -1, -1, -1, -1, -1, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, -1, -1, -1, -1, -1, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, -1, -1, -1, -1, 
  15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 4, 5, 6, 7, -1, -1, -1, -1, -1, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, -1, -1, -1, -1, -1, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 
  -1, -1, -1, -1, -1, 9, 8, 7, 6, 5, 4, 3, 3, 4, 5, 6, -1, -1, -1, -1, -1, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, -1, -1, -1, -1, -1, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 
  -1, -1, -1, -1, -1, 8, 7, 6, 5, 4, 3, 2, 2, 3, 4, 5, -1, -1, -1, -1, -1, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, -1, -1, -1, -1, -1, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 
  -1, -1, -1, -1, -1, 7, 6, 5, 4, 3, 2, 1, 1, 2, 3, 4, -1, -1, -1, -1, -1, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, -1, -1, -1, -1, -1, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, -1, -1, -1, -1, -1, 
  -1, -1, -1, -1, -1, 6, 5, 4, 3, 2, 1, 0, 0, 1, 2, 3, -1, -1, -1, -1, -1, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, -1, -1, -1, -1, -1, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, -1, -1, -1, -1, -1, 
  -1, -1, -1, -1, -1, 6, 5, 4, 3, 2, 1, 0, 0, 1, 2, 3, -1, -1, -1, -1, -1, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, -1, -1, -1, -1, -1, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, -1, -1, -1, -1, -1, 
  -1, -1, -1, -1, -1, 7, 6, 5, 4, 3, 2, 1, 1, 2, 3, 4, -1, -1, -1, -1, -1, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, -1, -1, -1, -1, -1, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, -1, -1, -1, -1, -1, 
  13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 2, 3, 4, 5, -1, -1, -1, -1, -1, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, -1, -1, -1, -1, -1, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, -1, -1, -1, -1, -1, 
  14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 3, 4, 5, 6, -1, -1, -1, -1, -1, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, -1, -1, -1, -1, -1, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, -1, -1, -1, -1, -1, 
  15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 4, 5, 6, 7, -1, -1, -1, -1, -1, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, -1, -1, -1, -1, -1, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 
  -1, -1, -1, -1, 12, 11, 10, 9, 8, 7, 6, 5, 5, 6, 7, 8, -1, -1, -1, -1, -1, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, -1, -1, -1, -1, -1, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 
  -1, -1, -1, -1, 13, 12, 11, 10, 9, 8, 7, 6, 6, 7, 8, 9, -1, -1, -1, -1, -1, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, -1, -1, -1, -1, -1, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 
  -1, -1, -1, -1, 14, 13, 12, 11, 10, 9, 8, 7, 7, 8, 9, 10, -1, -1, -1, -1, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, -1, -1, -1, -1, -1, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 
  -1, -1, -1, -1, 15, 14, 13, 12, 11, 10, 9, 8, 8, 9, 10, 11, -1, -1, -1, -1, -1, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, -1, -1, -1, -1, -1, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 
  -1, -1, -1, -1, 16, 15, 14, 13, 12, 11, 10, 9, 9, 10, 11, 12, -1, -1, -1, -1, -1, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, -1, -1, -1, -1, -1, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 
  21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 10, 11, 12, 13, -1, -1, -1, -1, -1, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, -1, -1, -1, -1, -1, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 
  22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 11, 12, 13, 14, -1, -1, -1, -1, -1, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, -1, -1, -1, -1, -1, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 
  23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 
  24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 
  25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 
  26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68
  };

        mapLength = 66;
        mapWidth  = 32;

        lengthModifier = fieldLength / mapLength;
        widthModifier  = fieldWidth  / mapWidth;
    }

    /* ---------------- Coordinate Conversion ---------------- */

    private int indexAt(Pose2d pose) {
        return indexAt(pose.getX(), pose.getY());
    }

    private int indexAt(double xMeters, double yMeters) {

        if (xMeters < 0 || yMeters < 0 ||
            xMeters >= fieldLength || yMeters >= fieldWidth) {
            return -1;
        }

        int gx = (int) (xMeters / lengthModifier);
        int gy = (int) (yMeters / widthModifier);

        if (gx < 0 || gx >= mapLength || gy < 0 || gy >= mapWidth) {
            return -1;
        }

        return gx + gy * mapLength;
    }

    private int xAt(int idx) { return idx % mapLength; }
    private int yAt(int idx) { return idx / mapLength; }

    private byte valueAt(int idx) {
        if (idx < 0 || idx >= map.length) return -1;
        return map[idx];
    }

    private Pose2d poseAtCenter(int idx, Rotation2d rot) {

        int gx = xAt(idx);
        int gy = yAt(idx);

        double x = (gx + 0.5) * lengthModifier;
        double y = (gy + 0.5) * widthModifier;

        return new Pose2d(x, y, rot);
    }

    /* ---------------- Neighbor Search ---------------- */

    private int bestNeighbor(int idx) {

        int x = xAt(idx);
        int y = yAt(idx);

        double minCost = Double.POSITIVE_INFINITY;
        int best = -1;

        for (int dx = -1; dx <= 1; dx++) {
            for (int dy = -1; dy <= 1; dy++) {

                if (dx == 0 && dy == 0) continue;

                int nx = x + dx;
                int ny = y + dy;

                if (nx < 0 || nx >= mapLength || ny < 0 || ny >= mapWidth)
                    continue;

                int nIdx = nx + ny * mapLength;

                byte base = valueAt(nIdx);
                if (base == -1) continue;

                double cost = base;
                if (dx != 0 && dy != 0) cost += 0.41;

                if (cost < minCost) {
                    minCost = cost;
                    best = nIdx;
                }
            }
        }
        return best;
    }

    /* ---------------- Lookahead Target ---------------- */

    public Pose2d bestAdjacent(Pose2d originalPose) {

        int idx = indexAt(originalPose);
        if (idx < 0) return null;

        int current = idx;
        int lastValid = idx;

        for (int i = 0; i < LOOKAHEAD_STEPS; i++) {
            int next = bestNeighbor(current);
            if (next < 0) break;
            lastValid = next;
            current = next;
        }

        return poseAtCenter(lastValid, originalPose.getRotation());
    }

    public int heatAt(Pose2d pose) {
        int idx = indexAt(pose);
        if (idx < 0) return -1;
        return valueAt(idx);
    }
}
